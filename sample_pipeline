pipeline {
environment {
registry = "aksharabits/sample"
dockerImage = ''
DOCKERHUB_CREDENTIALS = credentials('dockerhub_cred')
scannerHome = tool 'sonarqube_scanner'

}
agent any
stages {
stage('Cloning our Git') {
steps {
git 'https://github.com/AksharaBits/DevSecOps_Project.git'
}
}
stage('SonarQube Analysis') {
    
    withSonarQubeEnv() {
      sh "${scannerHome}/bin/sonar-scanner"
    }
    
  }
stage('Building our image') {
agent {label 'docker-agent'}
steps{
dir('Blog app'){
script {
sh 'docker build -t "$registry:$BUILD_NUMBER" -f docker/Dockerfile .'
//dockerImage = docker.build(registry + ":$BUILD_NUMBER", "docker/")
}
}
}
}
stage('Login') {
agent {label 'docker-agent'}
			steps {
				sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
			}
		}

stage('Deploy our image') {
agent {label 'docker-agent'}
steps{
script {
//docker.withRegistry( '', registryCredential ) {
 sh 'docker push "$registry:$BUILD_NUMBER"'
//dockerImage.push()
//}
}
}
}
stage('Cleaning up') {
agent {label 'docker-agent'}
steps{
sh "docker rmi $registry:$BUILD_NUMBER"
}
}

}
post {
agent {label 'docker-agent'}
		always {
			sh 'docker logout'
		}
	}
}
